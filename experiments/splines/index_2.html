<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Splines</title>
  <meta name="description" content="Splines">
  <meta name="author" content="rob">

  <!--<link rel="stylesheet" href="css/styles.css?v=1.0">-->

  <script src="pc.js"></script>
  <script src="math.js"></script>

  <script>

    const filenames = ['mt_doug_1.txt', 'mt_doug_2.txt', 'mt_doug_3.txt'];
    const pc = new PointCloud();
    
    let drawPc;

    let speed = 4.0;
    let nalpha = 25;
    let pcalpha = 25;
    let altitude = 10;
    let startTime;
    let running = false;

    let animY0 = 0;
    let animY1 = 0;
    let lookAhead = 20;

    const stylePoint = '#aaffaa';

    function update(evt) {
      if(evt)
        evt.preventDefault();
      nalpha = parseFloat(document.querySelector('#nalpha').value);
      pcalpha = parseFloat(document.querySelector('#pcalpha').value);
      altitude = parseFloat(document.querySelector('#altitude').value);
      speed = parseFloat(document.querySelector('#speed').value);
      lookAhead = parseFloat(document.querySelector('#lookahead').value);
    }

    function loadFile(evt) {
      evt.preventDefault();
      pc.load(evt.target.selectedOptions[0].text, (status, msg) => {
        if(status)
          pc.transform();
        document.querySelector('#loading').innerHTML = msg;
      });
    }

    function animateHull(timestamp) {
      if(startTime == null) {
        startTime = timestamp;
        requestAnimationFrame(animate);
        return;
      }
      const canv = document.querySelector('#canv');
      const ctx = canv.getContext('2d');
      const screen = new Bounds(0, 0, 0, canv.width, 0, canv.height);
      const t = (timestamp - startTime) / 1000.0;

      animY0 = t * speed;
      animY1 = animY0 + lookAhead;

      let slice = pc.sliceY(animY0, animY1);
      let hull = new PointCloud(getHull(slice.points, pcalpha));

      slice.scale(screen, pc.bounds);

      ctx.clearRect(0, 0, screen.length, screen.height);
      ctx.fillStyle = stylePoint;
      slice.points.forEach(pt => {
        ctx.fillRect(pt.y - 2, screen.zmax - pt.z - 2, 4, 4);
      });

      hull.scale(screen, pc.bounds);

      ctx.fillStyle = 'red';
      ctx.strokeStyle = 'red';
      ctx.beginPath();
      ctx.fillRect(hull.points[0].y - 2, screen.zmax - hull.points[0].z - 2, 4, 4);
      ctx.moveTo(hull.points[0].y, screen.zmax - hull.points[0].z);
      for(let i = 1; i < hull.points.length; ++i) {
        ctx.fillRect(hull.points[i].y - 2, screen.zmax - hull.points[i].z - 2, 4, 4);
        ctx.lineTo(hull.points[i].y, screen.zmax - hull.points[i].z);
      }
      ctx.stroke();

      if(running)
        requestAnimationFrame(animate);
    }

    let bins = new Map();
    let finals = new Map();

    function animate(timestamp) {
      if(startTime == null) {
        startTime = timestamp;
        requestAnimationFrame(animate);
        return;
      }
      const canv = document.querySelector('#canv');
      const ctx = canv.getContext('2d');
      const screen = new Bounds(0, 0, 0, canv.width, 0, canv.height);
      const t = (timestamp - startTime) / 1000.0;

      let bounds = pc.bounds.clone();

      let y = t * speed;
      let z = 100;

      let uav = new Point(0, y, z);
      let uavpc = new PointCloud([uav]);
      bounds.extend(uav);

      let slice = pc.sliceYRay(y, z, -Math.PI * 0.05, Math.PI / 180);

      slice.points.forEach(pt => {
        let y = parseInt(pt.y / 10) * 10;
        if(!bins.has(y) || pt.z > bins.get(y).z)
          bins.set(y, pt.clone());
      });

      slice.scale(screen, bounds);

      let heights = new PointCloud(Array.from(bins.values()));
      heights.scale(screen, bounds);

      ctx.clearRect(0, 0, screen.length, screen.height);
      ctx.fillStyle = stylePoint;
      slice.points.forEach(pt => {
        ctx.fillRect(pt.y - 2, screen.zmax - pt.z - 2, 4, 4);
      });

      ctx.fillStyle = 'red';
      heights.points.forEach(pt => {
        ctx.fillRect(pt.y - 2, screen.zmax - pt.z - 2, 4, 4);
      });

      uavpc.scale(screen, bounds);
      let uavpt = uavpc.points[0];
      ctx.fillStyle = 'black';
      ctx.fillRect(uavpt.y - 3, screen.zmax - uavpt.z - 3, 6, 6);

      if(running)
        requestAnimationFrame(animate);
    }

    function start(evt) {
      evt.preventDefault();
      update();
      startTime = null;
      running = true;
      bins.clear();
      requestAnimationFrame(animate);
    }

    function stop(evt) {
      evt.preventDefault();
      running = false;
    }

    function init() {
      let w = document.body.clientWidth;
      let h = 600;
      let canv = document.querySelector('#canv');
      canv.width = w;
      canv.height = h;
      let sel = document.querySelector('#filename');
      sel.add(new Option('', '- Select One -'));
      let i = 0;
      filenames.forEach(f => {
        sel.add(new Option(f, ++i));
      });
      sel.addEventListener('change', loadFile);
    }

  </script>

</head>

<body onload="init();">
  <form>
    <table>
      <tr><td><label for="filename">File</label></td><td><select name="filename" id="filename"></select> <span id="loading"></span></td></tr>
      <tr><td><label for="speed">Speed (m/s)</label></td><td><input name="speed" id="speed" value="4" /></td></tr>
      <tr><td><label for="lookahead">Look Ahead (m)</label></td><td><input name="lookahead" id="lookahead" value="4" /></td></tr>
      <tr><td><label for="pcalpha">Point Cloud Hull Alpha</label></td><td><input id="pcalpha" name="pcalpha" onchange="update(event);" value="25" /></td></tr>
      <tr><td><label for="nalpha">Normal Hull Alpha</label></td><td><input id="nalpha" name="nalpha" onchange="update(event);" value="25" /></td></tr>
      <tr><td><label for="altitude">Altitude</label></td><td><input id="altitude" name="altitude" onchange="update(event);" value="10" /></td></tr>
      <tr><td colspan="2"><button onclick="start(event);">Start</button> <button onclick="stop(event);">Stop</button></td></tr>
    </table>
  </form>
  <div style="border:1px solid #ccc">
    <canvas id="canv" width="2000" height="600" style="background-color: white"></canvas>
  </div>
</body>
</html>