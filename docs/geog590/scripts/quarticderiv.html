<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script>
	class Func {

		constructor(func, label, style, minx, maxx) {
			this.func = func;
			this.label = label;
			this.style = style;
			this.minx = parseFloat(minx);
			this.maxx = parseFloat(maxx);
		}

		limits(step) {
			let ymin = Number.MAX_VALUE;
			let ymax = -Number.MAX_VALUE;
			for(let x = this.minx; x <= this.maxx; x += step) {
				let y = eval(this.func);
				if(y < ymin) ymin = y;
				if(y > ymax) ymax = y;
			}
			return [this.minx, ymin, this.maxx, ymax];
		}

		draw(ctx, step, transform) {
			ctx.strokeStyle = this.style;
			ctx.beginPath();
			let x = this.minx;
			let [xt, yt] = transform(x, eval(this.func));
			ctx.moveTo(xt, yt);
			for(x = x + step; x <= this.maxx; x += step) {
				[xt, yt] = transform(x, eval(this.func));
				ctx.lineTo(xt, yt);
			}
			ctx.stroke();
		}

	}

	function draw() {

		const step = 0.1;

		let canv = document.querySelector('#canv');
		let ctx = canv.getContext('2d');
		let w = canv.width;
		let h = canv.height;
		
		ctx.clearRect(0, 0, w, h);

		let minx = Number.MAX_VALUE;
		let maxx = -Number.MAX_VALUE;
		let miny = Number.MAX_VALUE;
		let maxy = -Number.MAX_VALUE;
		funcList.forEach(f => {
			let [x0, y0, x1, y1] = f.limits(step);
			if(x0 < minx) minx = x0;
			if(x1 > maxx) maxx = x1;
			if(y0 < miny) miny = y0;
			if(y1 > maxy) maxy = y1;
		});

		const transform = function(x, y) {
			x = (x - minx) / (maxx - minx) * w;
			y = h - (y - miny) / (maxy - miny) * h;
			return [x, y];
		}

		funcList.forEach(f => {
			f.draw(ctx, step, transform);
		});
	}

	const funcList = [];
	const styleCol = ['red', 'blue', 'green', 'purple', 'yellow', 'orange', 'cyan', 'magenta'];

	function error(msg) {
		console.log('Error: ', msg);
	}

	function init() {
		try {
			let fl = JSON.parse(localStorage.getItem('funcs'));
			for(let i = 0; i < fl.length; ++i)
				fl[i] = Object.assign(new Func(), fl[i]);
			Array.prototype.push.apply(funcList, fl);
		} catch(err) {
			console.log(err);
		}
		let styleSel = document.querySelector('#style');
		styleSel.labels[0] = '-- Select One --';
		styleCol.forEach(col => { 
			styleSel.add(new Option(`${col}`));
		});
		updateFuncList();
	}

	function updateFuncList() {
		localStorage.setItem('funcs', JSON.stringify(funcList));
		const el = document.querySelector('#func_list');
		while(el.firstChild)
			el.removeChild(el.firstChild);
		for(let i = 0; i < funcList.length; ++i) {
			let item = document.importNode(document.querySelector('#func_tpl').content, true);
			let f = funcList[i];
			item.querySelector('span').innerHTML = `${f.label} (${f.style})`;
			item.querySelector('button').func_id = i;
			el.appendChild(item);
		}	
		draw();
	}

	function add_func(evt) {
		evt.preventDefault();
		const data = new FormData(evt.target);
		let func = data.get('func');
		let label = data.get('label');
		let minx = data.get('minx');
		let maxx = data.get('maxx');
		let style = data.get('style');
		if(!func || !label || !style || !minx || !maxx)
			error('A function, label and style are required!');
		funcList.push(new Func(func, label, style, minx, maxx));
		updateFuncList();
	}

	function del_func(evt) {
		evt.preventDefault();
		let id = parseInt(evt.target.func_id);
		funcList.splice(id, 1);
		updateFuncList();
	}
</script>
</head>
<body onload="init();">
	<div>
		<div>
			<form onsubmit="add_func(event)">
				<label for="func">Function <input name="func" /></label>
				<label for="label">Label <input name="label" /></label>
				<label for="minx">Min X <input name="minx" /></label>
				<label for="maxx">Max X <input name="maxx" /></label>
				<label for="style">Style <select name="style" id="style">-- Loading --</select></label>
				<button>Add</button>
			</form>
		</div>
		<div id="func_list">
		</div>
	</div>
	<canvas width="1000" height="600" id="canv"></canvas>

	<template id="func_tpl">
		<div><span class="func_label"></span><button onclick="del_func(event)">x</button></div>
	</template>

</body>