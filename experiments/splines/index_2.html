<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Splines</title>
  <meta name="description" content="Splines">
  <meta name="author" content="rob">

  <!--<link rel="stylesheet" href="css/styles.css?v=1.0">-->

  <script src="pc.js"></script>
  <script src="math.js"></script>

  <script>

    const filenames = ['mt_doug_1.txt', 'mt_doug_2.txt', 'mt_doug_3.txt'];
    const pc = new PointCloud();
    
    let running = false;
    let speed = 10.0;
    let altitude = 100.0;
    let angle = 30.0; // Down from horizontal.
    let binsize = 2.0;
    let spread = 0.3;

    const stylePoint = '#aaffaa';

    function update(evt) {
      if(evt)
        evt.preventDefault();
      altitude = parseFloat(document.querySelector('#altitude').value);
      speed = parseFloat(document.querySelector('#speed').value);
      binsize = parseFloat(document.querySelector('#binsize').value);
      angle = parseFloat(document.querySelector('#angle').value);
      spread = parseFloat(document.querySelector('#spread').value);
    }

    function loadFile(evt) {
      evt.preventDefault();
      pc.load(evt.target.selectedOptions[0].text, (status, msg) => {
        if(status)
          pc.transform();
        document.querySelector('#loading').innerHTML = msg;
      });
    }

    let bins = new Map();
    let finals = new Map();

    function animate(timestamp) {
      if(startTime == null) {
        startTime = timestamp;
        requestAnimationFrame(animate);
        return;
      }
      const canv = document.querySelector('#canv');
      const ctx = canv.getContext('2d');
      const screen = new Bounds(0, 0, 0, canv.width, 0, canv.height);
      const t = (timestamp - startTime) / 1000.0;

      let bounds = pc.bounds.clone();

      let y = t * speed;
      let z = altitude;

      let uav = new Point(0, y, z);
      let uavpc = new PointCloud([uav]);
      bounds.extend(uav);

      let slice = pc.sliceYRay(y, z, -angle * Math.PI / 180, spread * Math.PI / 180);

      slice.points.forEach(pt => {
        let y = parseInt(pt.y / binsize) * binsize;
        if(!bins.has(y) || pt.z > bins.get(y).z)
          bins.set(y, pt.clone());
      });

      slice.scale(screen, bounds);

      let heights = new PointCloud(Array.from(bins.values()));
      heights.scale(screen, bounds);

      ctx.clearRect(0, 0, screen.length, screen.height);
      ctx.fillStyle = stylePoint;
      slice.points.forEach(pt => {
        ctx.fillRect(pt.y - 2, screen.zmax - pt.z - 2, 4, 4);
      });

      ctx.fillStyle = 'red';
      heights.points.forEach(pt => {
        ctx.fillRect(pt.y - 2, screen.zmax - pt.z - 2, 4, 4);
      });

      uavpc.scale(screen, bounds);
      let uavpt = uavpc.points[0];
      ctx.fillStyle = 'black';
      ctx.fillRect(uavpt.y - 3, screen.zmax - uavpt.z - 3, 6, 6);

      if(running)
        requestAnimationFrame(animate);
    }

    function start(evt) {
      evt.preventDefault();
      update();
      startTime = null;
      running = true;
      bins.clear();
      requestAnimationFrame(animate);
    }

    function stop(evt) {
      evt.preventDefault();
      running = false;
    }

    function init() {
      let w = document.body.clientWidth;
      let h = 600;
      let canv = document.querySelector('#canv');
      canv.width = w;
      canv.height = h;
      let sel = document.querySelector('#filename');
      sel.add(new Option('', '- Select One -'));
      let i = 0;
      filenames.forEach(f => {
        sel.add(new Option(f, ++i));
      });
      sel.addEventListener('change', loadFile);

      document.querySelector('#altitude').value = altitude;
      document.querySelector('#speed').value = speed;
      document.querySelector('#binsize').value = binsize;
      document.querySelector('#angle').value = angle;
      document.querySelector('#spread').value = spread;

    }

  </script>

</head>

<body onload="init();">
  <form>
    <table>
      <tr>
        <td width="200"><label for="filename">File</label></td>
        <td width="300"><select name="filename" id="filename"></select> <span id="loading"></span></td>
        <td rowspan="7" style="padding-left: 20px;">
          <p>This thing demonstrates what the forward-looking laser will see. Choose a <strong>File</strong> and click <strong>Start</strong>.</p>
          <p>The laser angle is the angle down from horizontal, in degrees. The beam angle is the spread of the beam (nominally 0.3˚).</p>
          <p>The green dots are a point cloud extracted from a real lidar campaign. The laser sweeps back and forth across the swath, but the points are collapsed into a vertical plane, preserving only the y (forward) and z (vertical) dimensions.</p>
          <p>The red dots represent the highest point seen in the point cloud within a given bin in the y-space. As the laser penetrates the canopy, the maximum hight is revised up until the laser passes.</p>
          <p>The space between the "laser frontier" and the spot directly below the UAV is the space from which the trajectory must be derived. The length of this space is dynamic and depends on the altitude of the UAV above the surface. There is no accounting for occlusion.</p>
          <p>The black dot is the UAV.</p>
          <p>Next step: calculating the trajectory and following it.</p>
      </tr>
      <tr>
        <td><label for="speed">Speed (m/s)</label></td>
        <td><input name="speed" id="speed"  onchange="update(event);"/></td>
      </tr>
      <tr>
        <td><label for="angle">Laser Angle (˚, down)</label></td>
        <td><input name="angle" id="angle" onchange="update(event);" /></td>
      </tr>
      <tr>
        <td><label for="spread">Beam Angle (˚)</label></td>
        <td><input name="spread" id="spread" onchange="update(event);" /></td>
      </tr>
      <tr>
        <td><label for="binsize">Bin size (m)</label></td>
        <td><input id="binsize" name="binsize" onchange="update(event);" value="25" /></td>
      </tr>
      <tr>
        <td><label for="altitude">Altitude</label></td>
        <td><input id="altitude" name="altitude" onchange="update(event);" enabled="false" /></td>
      </tr>
      <tr>
        <td colspan="2"><button onclick="start(event);">Start</button> <button onclick="stop(event);">Stop</button></td>
      </tr>
    </table>
  </form>
  <div style="border:1px solid #ccc">
    <canvas id="canv" width="2000" height="600" style="background-color: white"></canvas>
  </div>
</body>
</html>