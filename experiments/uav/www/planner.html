<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>UAV Management</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
   integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
   crossorigin=""/>
<link rel="stylesheet" href="planner.css" />
<script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
   integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
   crossorigin=""></script>
<script>

	class Planner {

		constructor() {
			this._plan = 0;
			this._plans = new Map();

			this._planItemList = document.querySelector('#plan_list');
			this._planItemTpl = document.querySelector('#plan_item_template').content.lastElementChild;
			this._planItems = new Map();
		}

		addPlan(name = null) {
			const plan = new Plan(name, this);
			this._plans.set(plan.id, plan);
			this.update('plans');
		}

		addPlanClick(evt) {
			evt.preventDefault();
			this.addPlan();
		}

		planUpdate(name, plan, data) {
			console.log('plan update', name, plan, data);
		}

		update(name = null) {
			if(name == 'plans') {
				for(let [id, plan] of this._plans) {
					if(!this._planItems.has(id)) {
						var item = document.importNode(this._planItemTpl, true);
						item.textContent = plan.name;
						item.plan = plan;
						item.addEventListener('click', plan.select.bind(plan));
						this._planItemList.appendChild(item);
						this._planItems.set(id, item);
					}
				}
			}
		}
	}

	class BoundaryPoint {

		constructor(x, y, owner) {
			this.owner = owner;
			this.update(x, y);
		}

		update(x, y) {
			this.x = x;
			this.y = y;
			this.owner.pointUpdate(this);
		}

	}

	class Boundary {

		constructor(plan) {
			this.plan = plan;
			this.points = [];
		}

		addPoint(x, y) {
			this.points.push(new BoundaryPoint(x, y, this));
		}

		pointUpdate(point) {
			this.plan.boundaryUpdate(this, point);
		}

	}

	let __planId = 0;

	class Plan {

		constructor(name, observer) {
			this._id = ++__planId;
			this._name = name ? name : 'Plan ' + this.id;
			this._observer = observer;
			this._startPoint = null;
			this._endPoint = null;
			this._boundary = new Boundary(this);
		}

		select(evt = null) {
			this.notify('selected', this._observer);
		}

		get id() {
			return this._id;
		}

		get boundary() {
			return this._boundary;
		}

		set name(name) {
			this._name = name;
			this.notify('name', this._name);
		}

		get name() {
			return this._name;
		}

		set observer(observer) {
			this._observer = observer;
			this.notify('observer', this._observer);
		}

		get observer() {
			return this._observer;
		}

		set startPoint(pt) {
			this._startPoint = pt;
			this.notify('startPoint', this);
		}

		get endPoint() {
			return this._startPoint;
		}

		set endPoint(pt) {
			this._endPoint = pt;
			this.notify('endPoint', this);
		}

		get endPoint() {
			return this._endPoint;
		}

		notify(name, data = null) {
			setTimeout(() => { this._observer.planUpdate(name, this, data); }, 1);
		}

		boundaryUpdate(boundary, point) {
			this.notify('boundary', this);
		}

	}

	class Waypoint {

		constructor(x = 0, y = 0, z = 0, previous = null, next = null) {
			this.x = x;
			this.y = y;
			this.z = z;
			this.previous = previous;
			this.next = next;
		}

	}

	let map = null;
	let planner = null;

    function init() {

    	planner = new Planner();

		map = L.map('map').setView([51.505, -0.09], 13);
		L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
		}).addTo(map);

		L.marker([51.5, -0.09]).addTo(map)
			.bindPopup('A pretty CSS3 popup.<br> Easily customizable.')
			.openPopup();
    }

</script>
</head>
<body onload="init();">

	<button onclick="planner.addPlanClick(event);">Add Plan</button>

	<div id="map"></div>

	<div id="plan_list"></div>

	<template id="plan_item_template">
		<div class="plan_item"></div>
	</template>

</body>
</html>